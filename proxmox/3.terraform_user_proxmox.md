# üîê Creating a Terraform Role and Token in Proxmox VE 9

This guide explains how to create a **Terraform-specific user**, **role**, and **API token** in **Proxmox VE 9** using the CLI.

It‚Äôs a one-time setup ‚Äî after this, Terraform can deploy and manage VMs securely using an API token instead of passwords.

---

## üß© 1Ô∏è‚É£ Create a Terraform User

```bash
pveum user add terraform@pve --comment "Terraform automation user"
pveum passwd terraform@pve
```

This creates a dedicated user under the **PVE realm**.

---

## üß© 2Ô∏è‚É£ Create a Custom Role for Terraform

This role gives Terraform the privileges it needs to create and manage VMs and storage, without giving full root access.
Create the `TerraformRole` and token on your Proxmox host:

```bash
# Create role with required privileges
pveum role add TerraformRole -privs "VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.CPU VM.Config.Disk VM.Config.Memory VM.Config.Network VM.Config.Options VM.Config.Cloudinit VM.Console VM.Monitor VM.PowerMgmt Datastore.Allocate Datastore.AllocateSpace Datastore.Audit SDN.Use Pool.Allocate Sys.Audit Sys.Console VM.GuestAgent.Audit"

# Create user
pveum user add terraform@pve --comment "Terraform Automation User"

# Add API token
pveum user token add terraform@pve tf --comment "Terraform API token"

# Assign role permissions
pveum acl modify / -user terraform@pve -role TerraformRole
pveum acl modify /vms/8000 -user terraform@pve -role TerraformRole
pveum acl modify /storage/local-lvm -user terraform@pve -role TerraformRole
```

---

## üß© 3Ô∏è‚É£ Assign Role to the User

To grant the role cluster-wide (recommended for Terraform):

```bash
pveum acl modify / -user terraform@pve -role TerraformRole
```

Or limit it to one node:
```bash
pveum acl modify /nodes/node1 -user terraform@pve -role TerraformRole
```

---

## üß© 4Ô∏è‚É£ Create an API Token

This token allows Terraform to authenticate securely without using a password.

```bash
pveum user token add terraform@pve tf --comment "Terraform automation token"
```

Example output:
```json
{
  "full-tokenid": "terraform@pve!tf",
  "value": "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
}
```

Your final token for Terraform is:
```
terraform@pve!tf=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

---

## üß© 5Ô∏è‚É£ Test the Token

```bash
curl -k -H "Authorization: PVEAPIToken=terraform@pve!tf=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx" https://10.10.10.200:8006/api2/json/nodes
```

If you see JSON output with your node list, the token works üéâ

---

## üß© 6Ô∏è‚É£ Use in Terraform

Example `terraform.tfvars`:
```hcl
pm_api_url   = "https://10.10.10.200:8006/api2/json"
pm_api_token = "terraform@pve!tf=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
pm_node      = "node1"
pm_datastore = "local-lvm"
```

Provider block example:
```hcl
provider "proxmox" {
  endpoint  = var.pm_api_url
  api_token = var.pm_api_token
  insecure  = true
}
```

---

## ‚öôÔ∏è Optional: Cleanup or Rotate Token

Delete the token:
```bash
pveum user token delete terraform@pve tf
```

List all tokens for the user:
```bash
pveum user token list terraform@pve
```

---

## üß† Summary

| Step | Description |
|------|--------------|
| 1 | Create Terraform user |
| 2 | Create Terraform role |
| 3 | Assign role to user |
| 4 | Create API token |
| 5 | Test API token |
| 6 | Use in Terraform provider |

---

**Author:** Ramakrishna Mogallapu  
**Project:** HomeOps ‚Äî Terraform Automation for Proxmox VE 9  
**Version:** Proxmox VE 9 (Trixie)
**Date:** 19th oct 2025