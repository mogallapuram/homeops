# ğŸ” Creating a Terraform User and Token in Proxmox VE 9

Production-tested guide for creating a **Terraform-specific user**, **role**, and **API token** in **Proxmox VE 9** cluster using the CLI.

This is a one-time setup. After this, Terraform can deploy and manage VMs securely using an API token across all cluster nodes.

---

## ğŸ“‹ Prerequisites

- Proxmox VE 9 cluster
- Non-shared storage (local-lvm on each node)
- Cloud-init templates on nodes
- Root or sudo access to any cluster node

---

## ğŸš€ Quick Start

Run these commands **from ANY ONE node** in your cluster. The configuration will automatically replicate to all cluster members.

### 1ï¸âƒ£ Create the Terraform Role

Create a custom role with **all required privileges**:

```bash
pveum role add TerraformRole1 -privs "VM.Allocate,VM.Audit,VM.Clone,VM.Config.CDROM,VM.Config.CPU,VM.Config.Disk,VM.Config.Memory,VM.Config.Network,VM.Config.Options,VM.Config.Cloudinit,VM.Config.HWType,VM.Console,VM.PowerMgmt,Datastore.Allocate,Datastore.AllocateSpace,Datastore.Audit,SDN.Use,Pool.Allocate,Sys.Audit,Sys.Console,VM.GuestAgent.Audit"
```

> **âš ï¸ Important:** `VM.Config.HWType` is **required** for serial console and VGA configuration. Without it, VM creation will fail.

---

### 2ï¸âƒ£ Create the Terraform User

```bash
pveum user add terraform1@pve --comment "Terraform Automation User"
```

> **Note:** No password needed - we'll use API token authentication.

---

### 3ï¸âƒ£ Assign Permissions

Grant root and storage permissions:

```bash
# Root-level access (covers ALL VMs and templates automatically)
pveum acl modify / -user terraform1@pve -role TerraformRole1

# Storage access
pveum acl modify /storage/local-lvm -user terraform1@pve -role TerraformRole1
```

The root `/` permission with propagate flag `(*)` automatically covers:
- âœ… All existing templates
- âœ… All future templates you create
- âœ… All VMs across all nodes

**No need to add permissions for individual templates!**

---

### 4ï¸âƒ£ Create API Token

**CRITICAL:** Create token **AFTER** permissions are set, and use `--privsep 0`:

```bash
pveum user token add terraform1@pve tf --privsep 0 --comment "Terraform API token"
```

> **âš ï¸ ESSENTIAL:** The `--privsep 0` flag is **mandatory**! Without it, the token won't inherit user permissions and will fail with 403 errors.

**Expected output:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ key          â”‚ value                                           â”‚
â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•¡
â”‚ full-tokenid â”‚ terraform1@pve!tf                               â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ info         â”‚ {"comment":"Terraform API token","privsep":"0"} â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¼â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ value        â”‚ xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx            â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**âš ï¸ SAVE THE TOKEN VALUE IMMEDIATELY!**
- You **cannot retrieve it later**
- Verify `privsep` shows `"0"` (not `"1"`)

Your complete token:
```
terraform1@pve!tf=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

---

## âœ… Verification

### Verify User and Role

```bash
# Verify user was created
pveum user list | grep terraform1

# Verify role exists
pveum role list | grep TerraformRole1

# Verify ACLs (should show 2 entries: / and /storage/local-lvm)
pveum acl list | grep terraform1
```

### Verify Token Configuration

**Critical check - token must have privsep=0:**

```bash
pveum user token list terraform1@pve
```

**Expected output:**
```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ tokenid â”‚ comment             â”‚ expire â”‚ privsep â”‚
â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•ªâ•â•â•â•â•â•â•â•â•â•¡
â”‚ tf      â”‚ Terraform API token â”‚      0 â”‚ 0       â”‚  â† Must be 0!
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

### Verify All Permissions

```bash
pveum user permissions terraform1@pve
```

**You should see:**
- All permissions at `/` with `(*)` propagate flag
- All permissions at `/storage/local-lvm` with `(*)` propagate flag

**Key permissions to verify:**
- âœ… `VM.Clone (*)`
- âœ… `VM.Config.HWType (*)`
- âœ… `VM.Config.Cloudinit (*)`
- âœ… `Datastore.Allocate (*)`

### Test API Token

```bash
curl -k -H 'Authorization: PVEAPIToken=terraform1@pve!tf=YOUR-TOKEN-HERE' \
  https://$(hostname -I | awk '{print $1}'):8006/api2/json/nodes
```

**Expected result:** JSON output listing all nodes in your cluster.

---

## ğŸ› Common Issues & Solutions

### Issue 1: 403 Error - Permission Check Failed (VM.Clone)

**Symptom:**
```
Error: Permission check failed (/vms/8000, VM.Clone)
```

**Cause:** Token has privilege separation enabled (`privsep=1`)

**Solution:**
```bash
# Check token
pveum user token list terraform1@pve

# If privsep is 1, recreate the token:
pveum user token delete terraform1@pve tf
pveum user token add terraform1@pve tf --privsep 0 --comment "Terraform API token"

# Update terraform.tfvars with new token
```

---

### Issue 2: 403 Error - Permission Check Failed (VM.Config.HWType)

**Symptom:**
```
Error: Permission check failed (/vms/8201, VM.Config.HWType)
```

**Cause:** Role is missing VM.Config.HWType permission

**Solution:**
```bash
# Update the role to include VM.Config.HWType
pveum role modify TerraformRole1 -privs "VM.Allocate,VM.Audit,VM.Clone,VM.Config.CDROM,VM.Config.CPU,VM.Config.Disk,VM.Config.Memory,VM.Config.Network,VM.Config.Options,VM.Config.Cloudinit,VM.Config.HWType,VM.Console,VM.PowerMgmt,Datastore.Allocate,Datastore.AllocateSpace,Datastore.Audit,SDN.Use,Pool.Allocate,Sys.Audit,Sys.Console,VM.GuestAgent.Audit"

# Verify it was added
pveum user permissions terraform1@pve | grep HWType
```

---

### Issue 3: Template Not Found

**Symptom:**
```
Configuration file 'nodes/node1/qemu-server/8001.conf' does not exist
```

**Cause:** Template doesn't exist on the specified node

**Solution:**
```bash
# Verify templates exist
ssh root@node1 'qm list | grep 8000'
ssh root@node2 'qm list | grep 8001'

# Verify they're marked as templates
ssh root@node1 'qm config 8000 | grep template'
ssh root@node2 'qm config 8001 | grep template'

# Should show: template: 1
```

---

## ğŸ†• Adding New Templates

**No permission changes needed!** Root permission automatically covers all VMs.

```bash
# Create new template with any VMID
qm create 9000 --name new-template-name ...
qm template 9000

# Terraform can use it immediately - no additional ACLs required!
```

---

## ğŸ”„ Management Operations

### List All Tokens

```bash
pveum user token list terraform1@pve
```

### Delete Token

```bash
pveum user token delete terraform1@pve tf
```

### Regenerate Token

```bash
# Delete old token
pveum user token delete terraform1@pve tf

# Create new token (remember --privsep 0!)
pveum user token add terraform1@pve tf --privsep 0 --comment "Terraform API token"

# Update terraform.tfvars with new token value
```

### View User Permissions

```bash
pveum user permissions terraform1@pve
```

### Modify Role Permissions

```bash
# To add new permissions, include ALL existing ones plus new ones
pveum role modify TerraformRole1 -privs "VM.Allocate,VM.Audit,VM.Clone,VM.Config.CDROM,VM.Config.CPU,VM.Config.Disk,VM.Config.Memory,VM.Config.Network,VM.Config.Options,VM.Config.Cloudinit,VM.Config.HWType,VM.Console,VM.PowerMgmt,Datastore.Allocate,Datastore.AllocateSpace,Datastore.Audit,SDN.Use,Pool.Allocate,Sys.Audit,Sys.Console,VM.GuestAgent.Audit,NEW.Permission"
```

### Delete User (and all tokens)

```bash
pveum user delete terraform1@pve
```

---

## ğŸ“ Important Notes

### Template Management

- Root permission covers all templates automatically
- Create templates on any node with any VMID
- No need to add ACL entries for new templates
- Templates can be distributed across cluster nodes

### For Non-Shared Storage Clusters

1. **Template Synchronization:** Keep templates identical across nodes when you have the same template on multiple nodes.

2. **Storage Limitations:**
   - VMs cannot live-migrate between nodes
   - Use offline migration if needed (copies disk data)
   - Each node's local-lvm is independent

3. **Template Distribution:** 
   - Each node can have its own templates
   - Root permission covers all templates on all nodes

### Security Best Practices

1. **Token Storage:**
   - Never commit tokens to version control
   - Add `terraform.tfvars` to `.gitignore`
   - Use environment variables or secret managers in CI/CD

2. **Token Rotation:**
   - Rotate tokens periodically
   - Delete unused tokens immediately

3. **Principle of Least Privilege:**
   - TerraformRole1 only has VM management permissions
   - Does not have full administrator access
   - Scoped to VM operations and storage

4. **Privilege Separation:**
   - `--privsep 0` = Token inherits user permissions (required for automation)
   - `--privsep 1` = Token has separate permissions (requires additional ACLs)
   - Always use `--privsep 0` for Terraform

---

## ğŸ§© Complete Setup Summary

| Step | Command | Purpose | Critical Notes |
|------|---------|---------|----------------|
| 1 | `pveum role add TerraformRole1` | Create custom role | **Must include VM.Config.HWType** |
| 2 | `pveum user add terraform1@pve` | Create dedicated user | No password needed |
| 3 | `pveum acl modify /` | Root permissions | **Covers ALL VMs automatically** |
| 4 | `pveum acl modify /storage/local-lvm` | Storage access | For disk creation |
| 5 | `pveum user token add ... --privsep 0` | Generate API token | **Must use --privsep 0** |
| 6 | Test with curl | Verify token works | Should return node list |

**Total ACLs needed: 2** (/ and /storage/local-lvm)

---

## âš ï¸ Pre-Deployment Checklist

Before using the token in Terraform, verify:

- [ ] Role created with `VM.Config.HWType` permission
- [ ] User created successfully
- [ ] Root ACL applied (`/`)
- [ ] Storage ACL applied (`/storage/local-lvm`)
- [ ] Token created with `--privsep 0`
- [ ] Token privsep verified as `0` (not `1`)
- [ ] Token tested with curl successfully
- [ ] Token value saved securely
- [ ] Templates exist and are marked as templates

---

## ğŸ“š Additional Resources

- [Proxmox VE User Management](https://pve.proxmox.com/wiki/User_Management)
- [Proxmox VE API](https://pve.proxmox.com/wiki/Proxmox_VE_API)
- [Proxmox VE API Tokens](https://pve.proxmox.com/wiki/User_Management#pveum_tokens)

---

## ğŸ“ Production-Tested

This configuration has been tested and verified in production:
- âœ… Proxmox VE 9 (Trixie)
- âœ… 2-node cluster with non-shared storage
- âœ… Multiple template deployment
- âœ… K3s cluster deployment (5 VMs)
- âœ… Consul state backend integration

**Key Learnings:**
1. `VM.Config.HWType` is essential for serial console/VGA
2. Token must use `--privsep 0` for automation
3. Root permission eliminates need for per-template ACLs
4. Set permissions BEFORE creating token for cleaner workflow

---

**Author:** Ramakrishna Mogallapu  
**Project:** HomeOps â€” Terraform Automation for Proxmox VE 9  
**Version:** Proxmox VE 9 (Trixie)  
**Last Updated:** December 29, 2024  
**Status:** âœ… Production Tested & Verified
