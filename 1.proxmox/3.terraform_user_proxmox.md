# üîê Creating a Terraform Role and Token in Proxmox VE 9

This guide explains how to create a **Terraform-specific user**, **role**, and **API token** in **Proxmox VE 9** for a **2-node cluster with non-shared storage** using the CLI.

This is a one-time setup. After this, Terraform can deploy and manage VMs securely using an API token instead of passwords across both nodes.

---

## üìã Prerequisites

- Proxmox VE 9 cluster with 2 nodes
- Non-shared storage (local-lvm on each node)
- Cloud-init templates on both nodes:
  - VM ID 8000 on node1
  - VM ID 8001 on node2
- Root or sudo access to any cluster node

---

## üöÄ Quick Start

Run these commands **from ANY ONE node** in your cluster. The configuration will automatically replicate to all cluster members.

### 1Ô∏è‚É£ Create the Terraform Role

Create a custom role with all privileges Terraform needs to manage VMs and storage:

```bash
pveum role add TerraformRole -privs "VM.Allocate VM.Audit VM.Clone VM.Config.CDROM VM.Config.CPU VM.Config.Disk VM.Config.Memory VM.Config.Network VM.Config.Options VM.Config.Cloudinit VM.Console VM.Monitor VM.PowerMgmt Datastore.Allocate Datastore.AllocateSpace Datastore.Audit SDN.Use Pool.Allocate Sys.Audit Sys.Console VM.GuestAgent.Audit"
```

---

### 2Ô∏è‚É£ Create the Terraform User

```bash
pveum user add terraform@pve --comment "Terraform Automation User"
```

> **Note:** You don't need to set a password since we'll use API token authentication.

---

### 3Ô∏è‚É£ Create an API Token

```bash
pveum user token add terraform@pve tf --comment "Terraform API token"
```

**Expected output:**
```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ key                          ‚îÇ value                                ‚îÇ
‚ïû‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï™‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ïê‚ï°
‚îÇ full-tokenid                 ‚îÇ terraform@pve!tf                     ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ info                         ‚îÇ {"privsep":"0"}                      ‚îÇ
‚îú‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îº‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î§
‚îÇ value                        ‚îÇ xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

‚ö†Ô∏è **IMPORTANT:** Copy and save the token `value` - you cannot retrieve it later!

Your complete token will be:
```
terraform@pve!tf=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx
```

---

### 4Ô∏è‚É£ Assign Permissions

Grant cluster-wide access and specific permissions for templates and storage:

```bash
# Cluster-wide access (works across both nodes)
pveum acl modify / -user terraform@pve -role TerraformRole

# Grant access to both cloud-init templates
pveum acl modify /vms/8000 -user terraform@pve -role TerraformRole
pveum acl modify /vms/8001 -user terraform@pve -role TerraformRole

# Grant access to local-lvm storage on both nodes
pveum acl modify /storage/local-lvm -user terraform@pve -role TerraformRole
```

---

## ‚úÖ Verification

### Check User and Role Creation

```bash
# Verify user was created
pveum user list | grep terraform

# Verify role exists
pveum role list | grep TerraformRole

# Verify token was created
pveum user token list terraform@pve
```

### Test API Token

Replace `YOUR-TOKEN-HERE` with your actual token value:

```bash
curl -k -H "Authorization: PVEAPIToken=terraform@pve!tf=YOUR-TOKEN-HERE" \
  https://$(hostname -I | awk '{print $1}'):8006/api2/json/nodes
```

**Expected result:** JSON output listing both nodes in your cluster.

---

## üîß Terraform Configuration

### Provider Configuration

Create a `provider.tf` file:

```hcl
terraform {
  required_providers {
    proxmox = {
      source  = "telmate/proxmox"
      version = "~> 2.9"
    }
  }
}

provider "proxmox" {
  pm_api_url          = var.pm_api_url
  pm_api_token_id     = split("=", var.pm_api_token)[0]
  pm_api_token_secret = split("=", var.pm_api_token)[1]
  pm_tls_insecure     = true
}
```

### Variables Configuration

Create a `variables.tf` file:

```hcl
variable "pm_api_url" {
  description = "Proxmox API URL"
  type        = string
}

variable "pm_api_token" {
  description = "Proxmox API token (format: user@realm!token=secret)"
  type        = string
  sensitive   = true
}
```

### Terraform Variables

Create a `terraform.tfvars` file (‚ö†Ô∏è add to .gitignore):

```hcl
pm_api_url   = "https://10.10.10.200:8006/api2/json"  # Use any node IP
pm_api_token = "terraform@pve!tf=xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"
```

### Example VM Deployment

```hcl
# VM on node1 using template 8000
resource "proxmox_vm_qemu" "vm_node1" {
  name        = "ubuntu-vm-01"
  target_node = "node1"
  clone       = "8000"
  
  cores   = 2
  memory  = 2048
  scsihw  = "virtio-scsi-pci"
  
  disk {
    size    = "20G"
    type    = "scsi"
    storage = "local-lvm"
  }
  
  network {
    model  = "virtio"
    bridge = "vmbr0"
  }
}

# VM on node2 using template 8001
resource "proxmox_vm_qemu" "vm_node2" {
  name        = "ubuntu-vm-02"
  target_node = "node2"
  clone       = "8001"
  
  cores   = 2
  memory  = 2048
  scsihw  = "virtio-scsi-pci"
  
  disk {
    size    = "20G"
    type    = "scsi"
    storage = "local-lvm"
  }
  
  network {
    model  = "virtio"
    bridge = "vmbr0"
  }
}
```

---

## üîÑ Management Operations

### List All Tokens for User

```bash
pveum user token list terraform@pve
```

### Delete Token

```bash
pveum user token delete terraform@pve tf
```

### Regenerate Token

```bash
# Delete old token
pveum user token delete terraform@pve tf

# Create new token
pveum user token add terraform@pve tf --comment "Terraform API token"
```

### View User Permissions

```bash
pveum user permissions terraform@pve
```

### Delete User (and all tokens)

```bash
pveum user delete terraform@pve
```

---

## üìù Important Notes for Non-Shared Storage Clusters

1. **Template Synchronization:** Keep templates 8000 and 8001 identical. When you update one template, update the other.

2. **Storage Limitations:**
   - VMs cannot live-migrate between nodes
   - Use offline migration if needed (copies disk data)
   - Each node's local-lvm is independent

3. **Node Targeting:** Always specify `target_node` in Terraform to control which node hosts the VM.

4. **Template Selection:** Use the template ID that matches the target node:
   - node1 ‚Üí clone = "8000"
   - node2 ‚Üí clone = "8001"

---

## üîí Security Best Practices

1. **Token Storage:**
   - Never commit tokens to version control
   - Add `terraform.tfvars` to `.gitignore`
   - Use environment variables or secret managers in CI/CD

2. **Token Rotation:**
   - Rotate tokens periodically
   - Delete unused tokens immediately

3. **Principle of Least Privilege:**
   - The TerraformRole only has permissions needed for VM management
   - Does not have full root/administrator access

---

## üß© Summary

| Step | Command | Purpose |
|------|---------|---------|
| 1 | `pveum role add TerraformRole` | Create custom role |
| 2 | `pveum user add terraform@pve` | Create dedicated user |
| 3 | `pveum user token add terraform@pve tf` | Generate API token |
| 4 | `pveum acl modify / -user terraform@pve` | Grant cluster-wide access |
| 5 | Test with curl | Verify token works |
| 6 | Configure Terraform provider | Ready to deploy VMs |

---

## üìö Additional Resources

- [Proxmox VE User Management](https://pve.proxmox.com/wiki/User_Management)
- [Proxmox VE API](https://pve.proxmox.com/wiki/Proxmox_VE_API)
- [Telmate Terraform Provider Documentation](https://registry.terraform.io/providers/Telmate/proxmox/latest/docs)

---

**Author:** Ramakrishna Mogallapu  
**Project:** HomeOps ‚Äî Terraform Automation for Proxmox VE 9  
**Version:** Proxmox VE 9 (Trixie)  
**Last Updated:** December 29, 2025